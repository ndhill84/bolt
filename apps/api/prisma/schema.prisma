generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:../data/bolt.db"
}

model Project {
  id            String         @id @default(uuid())
  name          String
  description   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  stories       Story[]
  files         FileAsset[]
  agentSessions AgentSession[]
}

model Story {
  id                 String            @id @default(uuid())
  projectId          String
  title              String
  description        String?
  acceptanceCriteria String?
  status             String            @default("waiting")
  priority           String            @default("med")
  blocked            Boolean           @default(false)
  points             Int?
  assignee           String?
  dueAt              DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  project            Project           @relation(fields: [projectId], references: [id])
  notes              StoryNote[]
  labels             StoryLabel[]
  dependencies       StoryDependency[] @relation("StoryDepends")
  dependentOf        StoryDependency[] @relation("StoryDependents")
  files              FileAsset[]

  @@index([projectId, status])
}

model StoryNote {
  id        String   @id @default(uuid())
  storyId   String
  author    String
  body      String
  kind      String   @default("note")
  createdAt DateTime @default(now())
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId, createdAt])
}

model StoryDependency {
  id               String   @id @default(uuid())
  storyId          String
  dependsOnStoryId String
  type             String   @default("blocks")
  createdAt        DateTime @default(now())
  story            Story    @relation("StoryDepends", fields: [storyId], references: [id], onDelete: Cascade)
  dependsOn        Story    @relation("StoryDependents", fields: [dependsOnStoryId], references: [id], onDelete: Cascade)

  @@unique([storyId, dependsOnStoryId])
}

model StoryLabel {
  id      String @id @default(uuid())
  storyId String
  label   String
  story   Story  @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, label])
}

model FileAsset {
  id          String   @id @default(uuid())
  projectId   String
  storyId     String?
  filename    String
  contentType String
  byteSize    Int      @default(0)
  filePath    String
  textContent String?
  summary     String?
  uploadedBy  String
  createdAt   DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id])
  story       Story?   @relation(fields: [storyId], references: [id], onDelete: SetNull)

  @@index([projectId, storyId, createdAt])
}

model IdempotencyRecord {
  id          String   @id @default(uuid())
  key         String
  method      String
  route       String
  fingerprint String
  statusCode  Int
  responseBody String
  createdAt   DateTime @default(now())
  expiresAt   DateTime

  @@unique([key, method, route])
  @@index([expiresAt])
}

model AgentSession {
  id              String       @id @default(uuid())
  projectId       String
  title           String
  state           String
  startedAt       DateTime     @default(now())
  lastHeartbeatAt DateTime
  createdAt       DateTime     @default(now())
  project         Project      @relation(fields: [projectId], references: [id])
  events          AgentEvent[]

  @@index([projectId, state])
}

model AgentEvent {
  id        String       @id @default(uuid())
  sessionId String
  type      String
  message   String
  createdAt DateTime     @default(now())
  session   AgentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
}
